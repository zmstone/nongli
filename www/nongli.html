<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'/>
    <title>农历-> Google Calendar</title>

    <link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css"/>
    <link rel="stylesheet" href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css"/>
    <style type="text/css">
      body {
        padding-top: 10px;
        padding-bottom: 20px;
      }
      .container {
        margin: 0 auto;
        max-width: 800px;
      }
      .container > hr {
        margin: 10px 0;
      }
    </style>

    <script type="text/javascript" src="http://code.jquery.com/jquery.min.js"></script>
    <script type="text/javascript" src="http://twitter.github.com/bootstrap/assets/js/bootstrap.js"></script>

    <script type="text/javascript" src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
    <script type="text/javascript" src="http://documentcloud.github.com/backbone/backbone-min.js"></script>

    <script type="text/javascript" src="lunarmap.js"></script>
    <script type="text/javascript" src="jquery-ui-1.9.2.js"></script>
  </head>

  <script type="text/javascript">

  var Auth = Backbone.Model.extend({
    defaults: {
      client_id : '424449423080',
      apiKey    : 'AIzaSyATN8YFPrFOLLeRI7B0bRTFhT3TmjdtFds',
      scope     : 'https://www.googleapis.com/auth/calendar',
      authOk    : false,
    },
  });

  var AuthView = Backbone.View.extend({
    initialize: function() {
      _.bindAll(this, "render");
      this.model.bind("change", this.render);
    },
    render: function(){
      var divFail = $('#div_auth_fail');
      var divOk   = $('#div_auth_ok');
      if(this.model.get('authOk')){
        divFail.hide();
        divOk.show();
      }
      else{
        divFail.show();
        divOk.hide();
      }
      return this;
    },
  });

  var auth = new Auth();
  var authView = new AuthView({model: auth});

  function doAuthorize(isImmediate){
    var req = auth.toJSON();
    req.immediate = isImmediate;
    gapi.auth.authorize(req, function(result){
      auth.set({authOk: (result && !result.error)});
    })
  }

  function gapiLoaded(){
    gapi.client.setApiKey(auth.get('apiKey'));
    window.setTimeout(function(){doAuthorize(true)}, 10);
  }

  </script>
  <script type="text/javascript" src="https://apis.google.com/js/client.js?onload=gapiLoaded"></script>

  <script type="text/javascript">
  </script>

  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a class="btn-info" target='_blank' href="https://www.google.com/calendar/">查看 >></a></li>
        </ul>
        <h3 class="muted">农历 -> Google Calendar</h3>
      </div>
      <hr>
      <div id="div_auth_switch">
        <div id="div_auth_fail" style="text-align: center; display: none;">
          <p class="lead">编辑农历日期和事件并添加到 Google Calendar<br/></p>
          <a class="btn btn-large btn-success" href="#" onclick="doAuthorize(false)">Authorize</a>
        </div>
        <div id="div_auth_ok" style="display: none;">
          <p class="lead">TODO</p>
        </div>
      </div>
      <hr>
      <div class="footer">
        <p style="float:right;">zmstone艾特gmail.com</p>
      </div>
    </div>
  </body>
</html>

