<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'/>
    <title>农历-> Google Calendar</title>

    <link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css"/>
    <link rel="stylesheet" href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css"/>
    <style type="text/css">
      body {
        padding-top: 10px;
        padding-bottom: 20px;
      }
      table{
        margin-left: auto;
        margin-right: auto;
        text-align: center;
      }
      .container {
        margin: 0 auto;
        max-width: 800px;
      }
      .container > hr {
        margin: 10px 0;
      }
    </style>

    <script type="text/javascript" src="http://code.jquery.com/jquery.min.js"></script>
    <script type="text/javascript" src="http://twitter.github.com/bootstrap/assets/js/bootstrap.js"></script>

    <script type="text/javascript" src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
    <script type="text/javascript" src="http://documentcloud.github.com/backbone/backbone-min.js"></script>

    <script type="text/javascript" src="lunarmap.js"></script>
    <script type="text/javascript" src="jquery-ui-1.9.2.js"></script>
  </head>

  <script type="text/javascript">

  var Auth = Backbone.Model.extend({
    defaults: {
      client_id : '424449423080',
      apiKey    : 'AIzaSyATN8YFPrFOLLeRI7B0bRTFhT3TmjdtFds',
      scope     : 'https://www.googleapis.com/auth/calendar',
      authOk    : false,
    },
  });

  var AuthView = Backbone.View.extend({
    initialize: function() {
      _.bindAll(this, "render");
      this.model.bind("change", this.render);
    },
    render: function(){
      var divFail = $('#div_auth_fail');
      var divOk   = $('#div_auth_ok');
      if(this.model.get('authOk')){
        divFail.hide();
        divOk.show();
      }
      else{
        divFail.show();
        divOk.hide();
      }
      return this;
    },
  });

  var auth = new Auth();
  var authView = new AuthView({model: auth});

  function doAuthorize(isImmediate){
    var req = auth.toJSON();
    req.immediate = isImmediate;
    gapi.auth.authorize(req, function(result){
      auth.set({authOk: (result && !result.error)});
    })
  }

  function gapiLoaded(){
    gapi.client.setApiKey(auth.get('apiKey'));
    window.setTimeout(function(){doAuthorize(true)}, 10);
  }

  </script>

  <script type="text/javascript" src="https://apis.google.com/js/client.js?onload=gapiLoaded"></script>

  <script type="text/javascript">

$(function() {
  function datepickerOptions(altInputId) {
    var opt = {
      minDate: new Date(2000,1,5),
      maxDate: new Date(2100,11,31),
      changeMonth: true,
      changeYear: true,
      dateFormat: "yy-mm-dd",
    };
    if(altInputId){
      opt.altField = altInputId;
      opt.altFormat = "chinese-lunar";
    }
    return opt;
  }

  $("#datepicker").datepicker(datepickerOptions('#datepicker_alternate'));
  $("#datepicker").val((new Date()).toISOString().substr(0,10));
  $('#datepicker_alternate').val(LunarMap.toStr(LunarMap.date2l(new Date())));
  $("#recurrence_end").datepicker(datepickerOptions());
  $("#recurrence_end").val((new Date()).toISOString().substr(0,10));

  var Calendar = Backbone.Model.extend({
    toString: function(){
      return this.get('summary') + '(' + this.id + ')';
    },
    isNongli: function(){
      return this.get('summary').indexOf("农历") >= 0;
    },
    compareTo: function(other){
      if(this.isNongli()){
        if(other.isNongli()){
          return this.get('timestamp') > other.get('timestamp') ? -1 : 1;
        }
        return -1;
      }
      return 1;
    },
  });

  var CalendarList = Backbone.Collection.extend({
    model: Calendar,
    errMsg: '',
    initialize: function() {
      _.bindAll(this, "fetch");
      auth.bind("change", this.fetch);
    },
    fetch: function() {
      var self = this;
      gapi.client.load('calendar', 'v3', function() {
        var request = gapi.client.calendar.calendarList.list({});
        var now     = Date.now();
        request.execute(function(resp){
          var calendars = resp.items;
          if(calendars){
            for(var i = 0; i < calendars.length; i ++){
              if(calendars[i].accessRole == "owner"){
                calendars[i].timestamp = now;
                self.push(calendars[i]);
              }
            }
          }
          else{
            self.errMsg = 'failed to fetch calendars: ' +
                          resp.code + ', ' + resp.message;
            alert(self.errMsg);
          }
        })
      })
    },
    comparator: function(a, b){
      return a.compareTo(b);
    },
  });

  var CalendarListView = Backbone.View.extend({
    el: $('#calendar_list'),
    events: {
      'click #btn_new_calendar': 'newCalendar',
    },
    initialize: function() {
      _.bindAll(this, "render");
      this.collection.bind('all', this.render);
    },
    render: function(){
      if(this.collection.errMsg == ''){
        var select = $('#sel_calendars');
        select.empty();
        for(var i = 0; i < this.collection.length; i ++){
          var id   = this.collection.models[i].id;
          var text = '' + this.collection.models[i];
          select.append(new Option(text, id));
        }
        this.$el.show();
        $('#icon_loading_old').hide();
      }
      else{
        alert(this.collection.errMsg);
      }
    },
    newCalendar: function(){
      var summary = prompt("新建日历名称", "农历");
      if(!summary){ return false; }
      var resource = {
        "resource": { "summary": summary }
      };
      var request = gapi.client.calendar.calendars.insert(resource);
      var collection = this.collection;
      $('#icon_loading_new').show();
      request.execute(function(resp){
        if(resp.code == undefined){
          resp.timestamp = Date.now();
          var calendar = new Calendar(resp);
          collection.add(calendar);
        }
        else{
          alert('failed, reason: ' + resp.code + ',' + resp.message);
          return false;
        }
        $('#icon_loading_new').hide();
      });
      return true;
    }
  });

  var calendarListView = new CalendarListView({collection: new CalendarList()});

  var Recurrence = Backbone.Model.extend({
    defaults: {
      selected  : false,
      frequency : 0,
      unit      : "年",
      endDate   : new Date(),
    },
  });

  var RecurrenceView = Backbone.View.extend({
    el: $('#div_recurrence'),
    events: {
      'click #btn_a': 'update',
    },
    update: function(){
      alert('here we go');
    }
  });

  var recurrenceView = new RecurrenceView({model: new Recurrence()});

});

  </script>

  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a class="btn-info" target='_blank' href="https://www.google.com/calendar/">查看 >></a></li>
        </ul>
        <h3 class="muted">农历 -> Google Calendar</h3>
      </div>
      <hr>
      <div id="div_auth_switch">
        <div id="div_auth_fail" style="text-align: center; display: none;">
          <p class="lead">编辑农历日期和事件并添加到 Google Calendar<br/></p>
          <a class="btn btn-large btn-success" href="#" onclick="doAuthorize(false)">Authorize</a>
        </div>
        <div id="div_auth_ok" style='text-align: center;'>
          <div><img id="icon_loading_old" src="loading.gif"/></div>
          <table>
            <tbody>
              <tr id="calendar_list" style="display: none;">
                <td>*</td>
                <td>加到日历</td>
                <td><select id='sel_calendars'></select></td>
                <td>或者</td>
                <td>
                  <button id="btn_new_calendar" class="btn">新增一个日历</button>
                  <img id="icon_loading_new" src="loading.gif" style="display: none"/>
                </td>
              </tr>
              <tr>
                <td>*</td>
                <td>选择日期</td>
                <td><input type="text" id="datepicker"/></td>
                <td>农历</td>
                <td><input disabled=true type="text" id="datepicker_alternate" size="30"/></td>
              </tr>
              <tr>
                <td></td>
                <td>事件标题</td>
                <td><input type="text" id='event_summary'/></td>
                <td>描述</td>
                <td><input type="text" id='event_description'/></td>
              </tr>
              <tr>
                <td></td>
                <td>重复发生</td>
                <td>
                  每<input type='number' style="width: 60px;" value='0'/>
                  <select id='sel_recurrence' style="width: 60px;">
                    <option value='year'>年</option>
                    <option value='month'>月</option>
                    <option value='day'>天</option>
                  </select>一次
                </td>
                <td>直到</td>
                <td><input type="text" id="recurrence_end"/></td>
              </tr>
            </tbody>
          </table>
          <button id='doit' class='btn btn-large btn-primary'>噢啦</button>
        </div>
      </div>
      <hr>
      <div class="footer">
        <p style="float:right;">zmstone艾特gmail.com</p>
      </div>
    </div>
  </body>

</html>

