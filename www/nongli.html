<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'/>
    <title>农历-> Google Calendar</title>

    <link rel="stylesheet" href="http://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css"/>
    <link rel="stylesheet" href="http://twitter.github.com/bootstrap/assets/css/bootstrap.css"/>
    <style type="text/css">
      body {
        padding-top: 10px;
        padding-bottom: 20px;
      }
      .container {
        margin: 0 auto;
        max-width: 800px;
      }
      .container > hr {
        margin: 10px 0;
      }
    </style>

    <script type="text/javascript" src="http://code.jquery.com/jquery.min.js"></script>
    <script type="text/javascript" src="http://twitter.github.com/bootstrap/assets/js/bootstrap.js"></script>

    <script type="text/javascript" src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
    <script type="text/javascript" src="http://documentcloud.github.com/backbone/backbone-min.js"></script>

    <script type="text/javascript" src="lunarmap.js"></script>
    <script type="text/javascript" src="jquery-ui-1.9.2.js"></script>
  </head>

  <script type="text/javascript">

  var Auth = Backbone.Model.extend({
    defaults: {
      client_id : '424449423080',
      apiKey    : 'AIzaSyATN8YFPrFOLLeRI7B0bRTFhT3TmjdtFds',
      scope     : 'https://www.googleapis.com/auth/calendar',
      authOk    : false,
    },
  });

  var AuthView = Backbone.View.extend({
    initialize: function() {
      _.bindAll(this, "render");
      this.model.bind("change", this.render);
    },
    render: function(){
      var divFail = $('#div_auth_fail');
      var divOk   = $('#div_auth_ok');
      if(this.model.get('authOk')){
        divFail.hide();
        divOk.show();
      }
      else{
        divFail.show();
        divOk.hide();
      }
      return this;
    },
  });

  var auth = new Auth();
  var authView = new AuthView({model: auth});

  function doAuthorize(isImmediate){
    var req = auth.toJSON();
    req.immediate = isImmediate;
    gapi.auth.authorize(req, function(result){
      auth.set({authOk: (result && !result.error)});
    })
  }

  function gapiLoaded(){
    gapi.client.setApiKey(auth.get('apiKey'));
    window.setTimeout(function(){doAuthorize(true)}, 10);
  }

  </script>
  <script type="text/javascript" src="https://apis.google.com/js/client.js?onload=gapiLoaded"></script>

  <script type="text/javascript">

  var Calendar = Backbone.Model.extend({
    toString: function(){
      return this.get('summary') + '(' + this.id + ')';
    },
    isNongli: function(){
      return this.get('summary').indexOf("农历") >= 0;
    },
    compareTo: function(other){
      if(this.isNongli()){
        if(other.isNongli()){
          return this.get('timestamp') > other.get('timestamp') ? -1 : 1;
        }
        return -1;
      }
      return 1;
    },
  });

  var CalendarList = Backbone.Collection.extend({
    model: Calendar,
    errMsg: '',
    initialize: function() {
      _.bindAll(this, "fetch");
      auth.bind("change", this.fetch);
    },
    fetch: function() {
      var self = this;
      gapi.client.load('calendar', 'v3', function() {
        var request = gapi.client.calendar.calendarList.list({});
        var now     = Date.now();
        request.execute(function(resp){
          var calendars = resp.items;
          if(calendars){
            for(var i = 0; i < calendars.length; i ++){
              if(calendars[i].accessRole == "owner"){
                calendars[i].timestamp = now;
                self.push(calendars[i]);
              }
            }
          }
          else{
            self.errMsg = 'failed to fetch calendars: ' +
                          resp.code + ', ' + resp.message;
            alert(self.errMsg);
          }
        })
      })
    },
    comparator: function(a, b){
      return a.compareTo(b);
    },
  });

  var CalendarListView = Backbone.View.extend({
    tagName: 'select',
    initialize: function() {
      _.bindAll(this, "render");
      this.collection.bind('all', this.render);
    },
    render: function(){
      if(this.collection.errMsg == ''){
        var div = $('#div_calendar_list');
        this.$el.empty();
        for(var i = 0; i < this.collection.length; i ++){
          var id   = this.collection.models[i].id;
          var text = '' + this.collection.models[i];
          this.$el.append(new Option(text, id));
        }
        div.empty();
        div.append('*添加到日历&nbsp;');
        div.append(this.$el);
        div.append('&nbsp;或&nbsp;');
        div.append('<a class="btn" onclick="CalendarList.newCalendar()">新建一个日历</a>');
        div.append('<img id="icon_loading"src="loading.gif" style="display: none"/>');
      }
      else{
        alert(this.collection.errMsg);
      }
      return this;
    },
  });

  var calendarListView = new CalendarListView({collection: new CalendarList()});

  CalendarList.newCalendar = function(){
    var collection = calendarListView.collection;
    var summary = prompt("新建日历名称", "农历");
    if(!summary){
      return true;
    }
    var resource = {
      "resource": { "summary": summary }
    };
    var request = gapi.client.calendar.calendars.insert(resource);
    $('#icon_loading').show();
    request.execute(function(resp){
      if(resp.code == undefined){
        resp.timestamp = Date.now();
        var calendar = new Calendar(resp);
        collection.add(calendar).sort();
      }
      else{
        alert('failed, reason: ' + resp.code + ',' + resp.message);
        return false;
      }
      $('#icon_loading').hide();
    });
    return true;
  };

  $(function() {
    $("#datepicker" ).datepicker({
      minDate: new Date(2000,1,5),
      maxDate: new Date(2100,11,31),
      changeMonth: true,
      changeYear: true,
      dateFormat: "yy-mm-dd",
      altField: "#datepicker_alternate",
      altFormat: "chinese-lunar",
    });
  });

  </script>

  <body>
    <div class="container">
      <div class="masthead">
        <ul class="nav nav-pills pull-right">
          <li><a class="btn-info" target='_blank' href="https://www.google.com/calendar/">查看 >></a></li>
        </ul>
        <h3 class="muted">农历 -> Google Calendar</h3>
      </div>
      <hr>
      <div id="div_auth_switch">
        <div id="div_auth_fail" style="text-align: center; display: none;">
          <p class="lead">编辑农历日期和事件并添加到 Google Calendar<br/></p>
          <a class="btn btn-large btn-success" href="#" onclick="doAuthorize(false)">Authorize</a>
        </div>
        <div id="div_auth_ok">
          <div id="div_calendar_list"><img src="loading.gif"></img></div>
          <div id='div_datepicker'>
            *选择日期&nbsp;<input type="text" id="datepicker" />&nbsp;
            <input type="text" id="datepicker_alternate" size="30" />
          </div>
        </div>
      </div>
      <hr>
      <div class="footer">
        <p style="float:right;">zmstone艾特gmail.com</p>
      </div>
    </div>
  </body>
</html>

